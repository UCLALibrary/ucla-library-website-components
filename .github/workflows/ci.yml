name: Run CI Suite

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Cancel this run if a newer commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  percy-instructions:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Comment with percy instructions
        uses: bubkoo/auto-comment@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          pullRequestOpened: >
            # Percy Screenshots

            In order to conserve our percy screenshot allowance, percy is not configured to run automatically. Please make sure the PR is ready and all other checks are passing, then start it manually:

            1. Visit https://github.com/UCLALibrary/ucla-library-website-components/actions/workflows/percy.yml
            2. Click the 'Run workflow' button in the blue bar.
            3. Select the correct branch for this PR and click 'Run workflow' again to confirm.

  eslint:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/setup-workspace
      - run: pnpm -r run lint

  vite:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/setup-workspace
      - run: pnpm run build

  # --- Build Storybook once (no secrets) and publish artifact ---
  storybook-build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/setup-workspace
      - name: Cache Storybook Build
        id: cache-storybook
        uses: actions/cache@v3
        with:
          path: storybook-static
          key: storybook-${{ github.sha }}
      - run: pnpm --filter @ucla-library-monorepo/ucla-library-website-components run build-storybook
      - name: Upload storybook artifact
        uses: actions/upload-artifact@v4
        with:
          # Works for PRs (has PR number) and pushes (falls back to run_id)
          name: storybook-static-${{ github.event.pull_request.number || github.run_id }}-${{ github.sha }}
          path: packages/vue-component-library/storybook-static
          if-no-files-found: error
          retention-days: 3

  # --- Deploy (merged) on main/vue3.x pushes (uses secrets) ---
  storybook-merged-deploy:
    if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'vue3.x')
    needs: storybook-build
    permissions:
      contents: write
      pull-requests: write
      issues: write
      statuses: write
      deployments: write
    runs-on: ubuntu-latest
    steps:
      - name: Download storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static-${{ github.run_id }}-${{ github.sha }}
          path: storybook-static
      - name: Deploy to Netlify (merged)
        uses: nwtgck/actions-netlify@v2 # v1.2.3
        with:
          production-deploy: true
          deploy-message: https://github.com/UCLALibrary/ucla-library-website-component/commit/${{ github.sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          publish-dir: "./storybook-static"
          fails-without-credentials: true
          github-deployment-environment: test
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_STORYBOOK_VUE3X }}

  # --- Deploy preview for INTERNAL PRs (no approval needed) ---
  storybook-preview-internal:
    if: github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository
    needs: storybook-build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      statuses: write
      deployments: write
    steps:
      - name: Download storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static-${{ github.event.pull_request.number }}-${{ github.sha }}
          path: storybook-static
      - name: Deploy to Netlify (preview, internal)
        uses: nwtgck/actions-netlify@v2 # v1.2.3
        with:
          production-deploy: false
          deploy-message: https://github.com/UCLALibrary/ucla-library-website-component/pull/${{ github.event.pull_request.number }}
          alias: deploy-preview-${{ github.event.pull_request.number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          overwrites-pull-request-comment: true
          publish-dir: "./storybook-static"
          fails-without-credentials: true
          github-deployment-environment: storybook--${{ github.event_name }}-${{ github.event.number }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_STORYBOOK_VUE3X }}

  # --- Deploy preview for FORK PRs (requires approval via Environment) ---
  storybook-preview-fork:
    if: github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name != github.repository
    needs: storybook-build
    runs-on: ubuntu-latest

    # This is the protected environment you created in Settings → Environments
    environment:
      name: netlify-preview
      # Optional: show the URL on the PR after deploy
      url: ${{ steps.netlify.outputs.NETLIFY_URL }}

    permissions:
      contents: write
      pull-requests: write
      issues: write
      statuses: write
      deployments: write

    steps:
      - name: Download storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static-${{ github.event.pull_request.number }}-${{ github.sha }}
          path: storybook-static

      - name: Deploy to Netlify (preview, fork - gated)
        id: netlify
        uses: nwtgck/actions-netlify@v2
        with:
          production-deploy: false
          deploy-message: https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}
          alias: deploy-preview-${{ github.event.pull_request.number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          overwrites-pull-request-comment: true
          publish-dir: "./storybook-static"
          fails-without-credentials: true
          github-deployment-environment: storybook--${{ github.event_name }}-${{ github.event.number }}
        env:
          # These come from the protected Environment, only after approval
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_STORYBOOK_VUE3X }}

  storybook-cypress:
    needs: storybook-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      # Your workspace setup must NOT require secrets for forks
      - uses: ./.github/workflows/setup-workspace

      # 1) Get the static build produced earlier
      - name: Download storybook artifact
        uses: actions/download-artifact@v4
        with:
          name:
            storybook-static-${{ github.event.pull_request.number || github.run_id }}-${{ github.sha }}
            # ⬇️ put files into the package folder
          path: packages/vue-component-library

          # (Optional) sanity check
      - name: List served files
        working-directory: packages/vue-component-library
        run: |
          pwd
          ls -la storybook-static | sed 's/^/storybook-static: /'

      - name: Find Storybook path
        id: find_storybook
        run: echo "dir=$(find packages/vue-component-library -type d -name storybook-static | head -n1)" >> $GITHUB_OUTPUT

      # 2) Verify Cypress is installed (devDependency) in the filtered package
      - name: Verify Cypress Installation
        shell: bash
        run: pnpm --filter @ucla-library-monorepo/ucla-library-website-components exec cypress --version

      # 3) Run Cypress against the static Storybook
      - name: Cypress test for Storybook Components
        uses: cypress-io/github-action@v5
        with:
          install: false
          working-directory: ${{ steps.find_storybook.outputs.dir }}
          start: pnpm  exec http-server ./storybook-static -p 6006
          wait-on: http://localhost:6006
