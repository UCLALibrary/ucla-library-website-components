<template>
    <div class="block-form" v-if="!isClosed">
        <div class="success-message" v-if="hasNotifications">
            <h3>Registration complete</h3>
            <p>
                You can view your booking at calendar.library.ucla.edu or check
                your email.
            </p>

            <button
                type="button"
                class="notification--remove"
                @click="removeNotification()"
            >
                <svg-glyph-close class="svg-glyph-close" />
            </button>
        </div>

        <form
            id="app"
            @submit.prevent="checkForm"
            method="post"
            class="form"
            v-else
        >
            <div class="formTitleWrapper">
                <p class="formTitle">Registration (8 seats left)</p>

                <button type="button" @click="closeBlockForm()">
                    <svg-glyph-close class="svg-glyph-close" />
                </button>
            </div>

            <br />

            <div v-if="errors.length" class="form-errors">
                <!-- <p>Please correct the following error(s):</p> -->
                <!-- <ul>
                    <li
                        :key="index"
                        v-for="(error, index) in errors"
                        v-html="error"
                    />
                </ul> -->
                <p>
                    Please complete the required fields to complete registration
                </p>
            </div>

            <br v-if="errors.length" />

            <div class="registrationInfo">
                <p>Registration is required for this event.</p>
                <p class="requiredField">* Required Field</p>
            </div>

            <br />

            <div class="fullNameWrapper">
                <label>Full Name*</label>
                <div>
                    <input
                        id="firstName"
                        v-model="firstName"
                        type="text"
                        name="firstName"
                        required
                        aria-required="true"
                        placeholder="First Name"
                    />
                    <input
                        id="lastName"
                        v-model="lastName"
                        type="text"
                        name="lastName"
                        required
                        aria-required="true"
                        placeholder="Last Name"
                    />
                </div>
            </div>

            <br />

            <div v-if="block.emailMethod" class="emailLabelWrapper">
                <label for="email">
                    <span v-if="block.emailMethod.status == 'required'">
                        Email*
                    </span>
                    <span v-else>Email</span>
                </label>
                <input
                    id="email"
                    v-model="email"
                    type="email"
                    name="email"
                    :required="block.emailMethod.status"
                    :aria-required="block.emailMethod.status == 'required'"
                    v-bind="{}"
                />
            </div>

            <br />

            <div
                :key="question.id"
                v-for="question in parseQuestions"
                class="parsedQuestionsLabelWrapper"
            >
                <label
                    :for="question.id"
                    v-if="question.type !== 'string'"
                    :class="question.required ? 'questionRequired' : ''"
                >
                    <span v-if="question.required">{{ question.label }}*</span>
                    <span v-else>{{ question.label }}</span>
                </label>

                <div v-if="question.type == 'string'" class="textareaWrapper">
                    <label
                        :for="question.id"
                        :class="question.required ? 'questionRequired' : ''"
                    >
                        <span v-if="question.required"
                            >{{ question.label }}*</span
                        >
                        <span v-else>{{ question.label }}</span>
                    </label>
                    <textarea
                        v-model="formQuestions[question.id]"
                        placeholder="Add multiple lines"
                    />
                </div>

                <!-- TODO  do we need to add required to checkbox and radio and select inout elements -->
                <div v-if="question.type == 'radio'">
                    <div
                        :key="index"
                        v-for="(option, index) in question.options"
                        class="radioWrappper"
                    >
                        <input
                            type="radio"
                            :value="option"
                            v-model="formQuestions[question.id]"
                            :name="question.id"
                        />
                        <label :for="option">{{ option }}</label>
                    </div>
                </div>
                <div v-if="question.type == 'checkbox'">
                    <div
                        :key="index"
                        v-for="(option, index) in question.options"
                        class="checkboxWrapper"
                    >
                        <input
                            type="checkbox"
                            :id="option"
                            v-model="formQuestions[question.id]"
                            :true-value="option"
                            :value="option"
                        />
                        <label :for="option">{{ option }}</label>
                    </div>
                </div>

                <select
                    v-if="question.type == 'dropdown'"
                    :id="question.id"
                    v-model="formQuestions[question.id]"
                    :name="question.id"
                    :class="question.classes"
                >
                    <option disabled value="">Please select one</option>
                    <option
                        :key="index"
                        v-for="(option, index) in question.options"
                        v-bind:value="option"
                    >
                        {{ option }}
                    </option>
                </select>
            </div>

            <br />

            <button type="submit" class="submitButton">Register</button>
        </form>
    </div>
    <button class="submitButton" @click="closeBlockForm()" v-else>
        Register
    </button>
</template>

<script>
import SvgGlyphClose from "ucla-library-design-tokens/assets/svgs/icon-close.svg"
import SvgIconCheckbox from "ucla-library-design-tokens/assets/svgs/icon-checkbox.svg"

export default {
    name: "BlockForm",
    components: {
        SvgGlyphClose,
    },
    props: {
        block: {
            type: Object,
            default: () => {},
        },
        registrationType: {
            type: String,
            default: "online",
        },
        eventId: {
            type: String,
            default: "9383207",
            required: true,
        },
    },
    data() {
        return {
            errors: [],
            firstName: "",
            lastName: "",
            email: "",
            emailRequired:
                this.block.emailMethod.status == "required" ? true : false,
            questionsRequired: {},
            formQuestions: {},
            countdown: null,
            hasNotifications: false,
            sent: false,
            status: {},
            isClosed: false,
        }
    },
    watch: {
        status() {
            this.hasNotifications = true
            this.countdown = setTimeout(this.removeNotification, 113000)
        },
    },
    computed: {
        iconClass() {
            switch (this.status.code) {
                case "success":
                    return "fa-check"
                case "error":
                    return "fa-exclamation"
            }
            return ""
        },
        parseQuestions() {
            return this.block.questions.map((obj) => {
                if (
                    obj.type === "string" ||
                    obj.type === "radio" ||
                    obj.type === "dropdown"
                ) {
                    this.formQuestions[obj.id] = ""
                } else {
                    this.formQuestions[obj.id] = []
                }
                this.questionsRequired[obj.id] = obj.required
                return {
                    ...obj,
                    classes: `input-${obj.type}`,
                }
            })
        },
    },
    methods: {
        removeNotification() {
            clearTimeout(this.countdown)
            this.hasNotifications = false
        },
        /*encode(data) {
            return Object.keys(data)
                .map(
                    (key) =>
                        `${encodeURIComponent(key)}=${encodeURIComponent(
                            data[key]
                        )}`
                )
                .join("&")
        },*/
        handleSubmit() {
            const data = {
                form: {
                    first_name: this.firstName,
                    last_name: this.lastName,
                    email: this.email,
                    questions: [],
                },
                registration_type: this.registrationType,
            }
            data.form.questions = this.block.questions.map((obj) => {
                return {
                    id: obj.id,
                    answer: this.formQuestions[obj.id],
                }
            })
            console.log(JSON.stringify(data))
            let url = `https://test.proxy.calendar.library.ucla.edu/api/1.1/events/${this.eventId}/register`
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: JSON.stringify(data),
            })
                .then((data) => {
                    console.log(data)
                    this.sent = true
                    this.status = {
                        code: "success",
                        text: "One seat is sent to LibCal to be registered or will be on wait list",
                    }
                })
                .catch((err) => {
                    console.error(err)
                    this.sent = true
                    this.status = {
                        code: "error",
                        text: err,
                    }
                })
        },

        checkForm(e) {
            let fullNameValid = false
            let emailValid = false

            if (this.firstName && this.lastName) {
                fullNameValid = true
            }
            if (this.emailRequired && this.email) {
                emailValid = true
            }

            this.errors = []
            if (!fullNameValid) {
                this.errors.push("Full Name required.")
            }
            if (!emailValid) {
                this.errors.push("Email required.")
            }

            for (let question of this.block.questions) {
                if (
                    this.questionsRequired[question.id] &&
                    !this.formQuestions[question.id]
                ) {
                    question.type === "string"
                        ? this.errors.push(
                              this.block.questions.label + " required."
                          )
                        : this.errors.push(question.label + " required.")
                } else if (
                    this.questionsRequired[question.id] &&
                    question.type == "checkbox" &&
                    this.formQuestions[question.id].length == 0
                ) {
                    this.errors.push(question.label + " required.")
                }
            }

            if (this.errors.length == 0) {
                this.handleSubmit()
            } else {
                window.scrollTo(0, 0)
            }
        },
        closeBlockForm() {
            this.isClosed = !this.isClosed
        },
    },
}
</script>

<style lang="scss" scoped>
.block-form {
    border-radius: var(--rounded-slightly-all);
    border-color: var(--color-primary-blue-03);
    margin-bottom: var(--space-l);
    max-width: $container-l-text + px;
    padding: var(--space-xl);

    @media #{$medium} {
        max-width: 100%;
        min-width: 600px;
    }

    @media #{$small} {
        max-width: 100%;
        min-width: 320px;
    }

    .formTitleWrapper {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        border-bottom: 1px solid var(--color-secondary-grey-02);
    }

    .formTitle {
        @include step-1;
    }

    label {
        @include step-0;
        display: flex;
        flex-direction: row;
        width: 148px;
        gap: var(--space-s);
        margin-right: 16px;

        @media #{$medium} {
            width: 100%;
            align-items: flex-start;
        }
    }

    label:required {
        @include step-0;
        font-weight: $font-weight-medium;
    }

    ::placeholder {
        @include step--1;
        color: var(--color-secondary-grey-04);
    }

    .registrationInfo {
        display: flex;
        flex-direction: row;
        justify-content: space-between;

        @media #{$small} {
            flex-direction: column;
            gap: 8px;
        }

        .requiredField {
            font-weight: $font-weight-medium;
        }
    }

    .fullNameWrapper {
        display: flex;
        flex-direction: row;
        align-items: center;

        label {
            font-weight: $font-weight-semibold;
            text-align: end;
        }

        div {
            display: flex;
            flex: auto;
            justify-content: space-between;

            input {
                padding: 8px 16px;
                width: 49%;
            }
        }

        @media #{$medium} {
            flex-direction: column;
            max-width: 100%;
            align-items: flex-start;
            div {
                width: 100%;
            }
        }
    }

    .emailLabelWrapper {
        display: flex;
        flex-direction: row;
        align-items: center;
        label {
            font-weight: $font-weight-semibold;
        }
        input {
            padding: 8px 16px;
            flex: auto;
        }

        @media #{$medium} {
            flex-direction: column;
            max-width: 100%;
            align-items: flex-start;

            input {
                width: 100%;
            }
        }
    }

    .parsedQuestionsLabelWrapper {
        display: flex;
        flex-direction: row;
        align-items: center;
        margin-bottom: 1em;

        label {
            align-self: flex-start;
        }

        input {
            flex: auto;
        }

        @media #{$medium} {
            flex-direction: column;
            width: 100%;
            align-items: flex-start;
        }
    }

    .checkboxWrapper {
        display: flex;
        flex-direction: row;
        align-items: center;
        margin-bottom: 16px;

        input {
            margin-right: 14px;
        }
    }

    textarea {
        padding: 8px 16px;
        border-radius: var(--rounded-slightly-all);
    }

    input {
        border: 1px solid;
        border-color: var(--color-secondary-grey-03);
        border-radius: var(--rounded-slightly-all);
        font: {
            color: var(--color-secondary-grey-04);
        }
        @include shadow-state-change;

        @include step--1;
        color: var(--color-secondary-grey-05);

        &:hover {
            border-color: var(--color-default-cyan-03);
        }

        &:focus {
            border-color: var(--color-default-cyan-03);
            font {
                color: var(--color-secondary-grey-04);
                @include shadow-state-change;
            }
        }

        &:active {
            border-color: var(--color-default-cyan-03);
            font {
                color: var(--color-secondary-grey-05);
            }
            background-color: var(--color-primary-blue-01);
        }

        // &:invalid {
        //     border-color: var(--color-status-error-02);
        //     font {
        //         color: var(--color-secondary-grey-05);
        //     }
        // }
    }

    select {
        padding: 11.5px 16px;
        flex: auto;
        border-radius: var(--rounded-slightly-all);
        width: 100%;
        background: white;
    }

    .textareaWrapper {
        display: flex;
        flex-direction: column;
        flex: auto;

        label {
            width: auto;
            margin-bottom: 10px;
        }
        @media #{$medium} {
            width: 100%;
        }
    }

    .radioWrappper {
        display: flex;
        flex-direction: row;
        margin-bottom: 16px;

        label {
            align-self: flex-start;
            @media #{$medium} {
                align-self: flex-start;
                width: 100%;
            }
        }

        input {
            margin-right: 16px;
        }
    }

    .questionRequired {
        font-weight: $font-weight-semibold;
    }

    .success-message {
        position: fixed;
        z-index: 5;
        box-sizing: border-box;
        top: 10px;
        right: 1%;
        width: 98%;
        padding: 20px;
        box-shadow: 0 5px 15px 0 rgba(0, 0, 0, 0.3);
        overflow: hidden;
        border-radius: var(--rounded-slightly-all);
        background: white;

        border: 2px solid #64b587;

        h3 {
            @include step-1;
            padding-bottom: 9px;
            border-bottom: 1px solid var(--color-secondary-grey-01);
        }

        .notification--remove {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 15px;
            &:hover {
                cursor: pointer;
            }
        }
    }
    .form-errors {
        background-color: var(--color-status-error-01);
        box-sizing: border-box;
        padding: 20px;
        border-radius: var(--rounded-slightly-all);
    }
}

.submitButton {
    box-sizing: border-box;
    position: relative;
    @include button;
    min-height: 48px;
    padding: 4px 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    border: 1.5px solid var(--color-primary-blue-02);
    transition-property: all;
    @include animate-normal;
    overflow: hidden;
    z-index: 0;

    background-color: var(--color-primary-blue-03);
    --button-background-slide: var(--color-white);
    border-color: var(--color-primary-blue-03);
    color: var(--color-white);

    .label {
        white-space: nowrap;
    }

    &::before {
        content: "";
        width: 100%;
        height: 100%;
        background-color: var(--button-background-slide);
        position: absolute;
        top: 0;
        left: -100%;
        transition-property: all;
        @include animate-normal;
        z-index: -10;
    }

    // Hover states
    @media #{$has-hover} {
        &:hover,
        &:focus,
        &:focus-visible {
            cursor: pointer;
            border-color: var(--color-primary-blue-02);
            color: var(--color-black);

            &::before {
                left: 0;
            }
        }

        &:focus,
        &:focus-visible {
            outline: none;
            border-radius: 0;
        }
    }
    // Breakpoints
    @media #{$medium} {
        padding: 4px 16px;
        display: inline-flex;
    }

    @media #{$small} {
        width: 100%;
    }
}
</style>
